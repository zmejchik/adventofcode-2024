// https://adventofcode.com/2024/day/6

const main = (
  input = puzzleInputSAMPLE.split("\n").map((line, y) => line.split("").map((c, x) => ({ c, x, y }))),
  start = input.flat().find(({ c }) => c === "^"),
  findWhereToGo = (input, pos, Δ) =>
    loop(Δ, (Δ, _, nextCell = input.map[pos?.y + Δ.y]?.[pos?.x + Δ.x]) =>
      nextCell?.c === "#" || (nextCell && input.obstruction === nextCell)
        ? Δ.next // try another dir
        : stop({ pos: nextCell, Δ, turn: `${pos.x}/${pos.y}/${Δ.d}` })
    ),
  escapeFromMap = input =>
    loop(
      { pos: start, Δ: dirs[0], acc: new Set([start]), turns: new Set([]) }, // starter state
      ({ pos, Δ, acc, turns }, _, next = findWhereToGo(input, pos, Δ)) =>
        turns.has(next.turn) // stuck in a loop
          ? stop(false)
          : !next.pos // escaped from map
          ? stop(acc.size)
          : // go with next position and direction, but remember this position and turn
            { ...next, acc: acc.add(next.pos), turns: turns.add(next.Δ !== Δ ? next.turn : null) }
    )
) => ({
  p1: escapeFromMap({ map: input }),
  p2: input.flat().filter(
    // non-optimal: find all obstructions that make it impossible to escape
    ({ x, y }) => !escapeFromMap({ map: input, obstruction: input[y][x] })
  ).length,
});

// utils and hacks

const loopingList = arr => arr.map((e, i) => (e.next = arr[(i + 1) % arr.length]) && e);
const dirs = loopingList([
  { x: 0, y: -1, d: "^" },
  { x: 1, y: 0, d: ">" },
  { x: 0, y: 1, d: "v" },
  { x: -1, y: 0, d: "<" },
]);

const stop = res => ({ ...stop, res, STOP: true, withRes: true });
const loop = (acc = [], fn, i = 0, continue_ = 1) => {
  while ((continue_ = fn(acc, i++))?.STOP !== true) acc = continue_;
  return continue_.withRes ? continue_.res : acc;
};

// inputs

const puzzleInputSAMPLE = `
....#.....
.........#
..........
..#.......
.......#..
..........
.#..^.....
........#.
#.........
......#...`.trim();
//23456789

const puzzleInput = `
.........................................#...............................#..........#.......................#.....................
................#.........................................#.................................#..........#...#......................
......................#...#............#..................#......................#.##........#............#.......................
...........................#...............................##.................#..............#............#.......................
..........#....#...............#.........#.................................#.......#.....................#..........#..........#..
..........................................#..............#...............................#.......................#................
.................#..#..........#.#..................#................................#.......#.#........#....#....#...............
.......#............#....................................#..#.....##...............................#........##...........#........
......#..................................................#.....#..................#......................................#........
....................................................................................................#...#.......#.............#...
.....#...................................................#...........#...##........##.................................#...........
........................#..........................#...............#.......#............#..#..........##..............#...........
.....................#...................................#.........................#..............#......#..................#.....
.........#.#....#.....#...................................#....................................#..................................
.........#.#......#.........................#............................................#...#...................................#
.........................................#.#...............................#..............#..............................#........
#...........#...................#.....#..................#.........#...#...................#.............................##.....#.
#....#..........#............#................................#...#............##.....#....................#......................
#.................................##...#........#..............#.......#..........#....................................#.........#
..............#...#...............................................#................#........#...#.................#......#........
..............#.....................#.....#...........#............#...#.......##.........................##.#....................
....#............................................##...................#.......................................#........#..........
.................................................................................#...#............................................
....................................#...................#.........#......#.....#...#.............................#..............#.
.....#................................#................................#........................................................#.
.............................................#..........##........#.........#..........................#..........................
...............#..#...........#.......#........................#.........#.....................................................##.
...#....................#.........................#..#............................#...........#..#...#...............#............
........#.....................................#.......................................................#...#..#.........#.#......#.
...........................................#...............#............................................................#.....#...
.........................................#.....#............##......................#..............................#..............
..#...............#.............................#............................#.........#.......#..................................
..............................................................................................................#.............#....#
..................#.#.............#......................................#.......#...............#..........#.....................
........................#.#.......#..........#...#......#.........#......#.................#........#.......#............#....#.#.
..#.....................................................................#......................#...............#..................
..................................................................#......#............................#........#........#.........
......................................#.....................#..................#..............#...................................
................#..#.....................................................#....................................#..........#........
...................................#........................................#.#..#............................................##..
...............................#.........................#..........................#............................#.........#......
............................#........#..............#.............#.#........................................................#....
................#..................#.....#......................#.....................................................#...........
......................#........#............#..................#...............#...............#..................................
......................................................#..................................................#........................
................#.......#..................................................................#......................................
....................................#....#...............#........................................................................
.................................................................................................#...#.#..........................
.......#..#...........#.....#...............................................................................#..............#......
...#.................#.................^...................#.....#................................................................
...............#.............................................................................#.................................#..
............................................#.....#............................................................#.#........##......
................................#................................#.......#..#......#...................#......#..............#....
...................##...........................................................#.................................................
...........................#...................#..........#...................................#............#.............#...#....
.....#........................#...............#..#.#.......#...................................#.##...............#...#...........
...#.....................#.#.......................#..........#.............................................................#.....
.......#.........................................#.........#.............#....................##...........................#......
.......................................##...........#.................#.......................................#..................#
................................#.......#..........................#........#.#........#..........#...........#....##.............
.......#............#....#....................................#.....#...............#.............................................
..........#.................#............................................................................#.............#....#...#.
...#.......................#.................................................................................................#....
.......................#....#..........................................................................................#..........
......................................................................#...............................#............#....#.........
.....#..............................................................................#............#...........................#....
..#.............#..#.............#...#............................................................................................
....................................................#.......#.............................#....#............#...................#.
....................................................................#.#...#....................................#..........#.......
......#...#................#.........#.................##......................#........................#.........................
.............#.#...........#..........................................................................#...........................
..........#.....#........#........................................................................#.#.................#...........
..........#.##....................................#......#................#..........#..........#.......##.....#..................
.............................#................................................................##.............#....................
....................................#.................................................................................###.........
..................................#..........#...................................#......#.........................................
...............#...........#.............................................#......#...................................#.............
...............#...#...................................................#...................#............#...................#.....
........................................#......#.............#........#..........................#....#.....#..................#..
.......................#......................................................................#.......#...................#.....##
.................#.....................#............#............................#..........#......................#..............
....................#................................................................#................#......#.#..................
.#............#...............................................#..#......##.#................................##....#...............
.#.......#..........................................................................................................#.............
.................#............#...............................................................................#...................
.................................##......................................#.........................#................#.............
...................#.............................................................#................................................
...#.....#..#......#........#....#.................#..................#..#......................................#...........#...#.
.#.....................#...........................................................................#............................#.
.#............................#.........#...............................................#.........................................
....#......................#......................#....#........#.....#...................................#......................#
.......#.................#..............................#.....#......................#...............#..............#.......#.....
...#.................................................................................................#........#.....#......#......
......##...................................................................................#................................#.....
..........#................................#..................................#.................................................#.
...........#........#..............#...#..............#...................................................#......#.........#......
.......#...#....................................#..##.........................................................#...................
...........#............................................##..........#..#.#.....................................................#..
...................................#............................#..............#..#..................................#............
....#.......#...............#...........................................................................#.........................
...............#.....................................................................................................#............
................#..........................................#...............##...........................#....#..........#.........
...........................................#...................................................................................#..
.................#..........................................................................#.....#.............##..........#.....
...............#..................#................................#.......................#...#.....##...........................
.............#.......................#.......#.............#.#...#......#..............#.............................#.#..........
..........##....#..#..............................#...............................................................................
.................#......#.......#.....#..........#.............................#......................#.....#.....................
....#........#....................#.#.........#.#..........#......................................................................
...........................#.......#........#.........................#.#.................#........#...............#......#.......
#..#..................#...........#.....................................................................................#.........
......#...#.#...........#.....................................................#................#..#............#..................
................##.#...#..............#..............................#............................................................
...........................................................................................#.............................#........
.......#....#...................#..........................................................#............#............#.....#......
.............#....#..................................#....#........#.....................................#.#....#..............#.#
.#..................................................#...................#...............#.........................................
...#........#..................................#............#.#.......................................#...........................
................#.....#....................................#.#.#...........#......##................#.................#......#....
...#.......................#...........#...#...........#.#........................#..#.................##.....#...................
.............#.......................................#................#....#..#..#.....................#...#............#.........
..........#..................#............#...#..................#................................................................
.........#..........#.....................#..#................#.......................#.........#.......##..#.#....#.....#....#...
#..........................#.#...........#.#.........#............................................................................
..................#.....................#......#.##...................#................................................#..#.......
.....#....#......#..#............................##.........................................................#.....#.......#...##..
....#...#.#...##..................#..........................................................#.....#..............................
..............................#............#...........#..................................#....#............#.......#.............
....................................#.....................#............................#..............#...........................
............#............#..........#....##....................................#..#.....#..................#......................`.trim();

require("util").inspect.defaultOptions.depth = null;
console.log(main());